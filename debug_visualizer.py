"""
Pipeline å¯è§†åŒ–å·¥å…· - ç”Ÿæˆäº¤äº’å¼HTMLè°ƒè¯•æŠ¥å‘Š
==============================================

åŠŸèƒ½ï¼š
1. ç”Ÿæˆç¾è§‚çš„HTMLè°ƒè¯•æŠ¥å‘Š
2. å±•ç¤ºæ¯ä¸ªæ­¥éª¤çš„è¯¦ç»†ä¿¡æ¯
3. æä¾›äº¤äº’å¼æ•°æ®æŸ¥çœ‹
4. åŒ…å«è´¨é‡è¯„ä¼°å’Œå»ºè®®
"""

import os
import json
import logging
from typing import Dict, Any, List
from datetime import datetime
from pathlib import Path

logger = logging.getLogger(__name__)

class PipelineVisualizer:
    """Pipeline å¯è§†åŒ–å™¨ - ç”ŸæˆHTMLæŠ¥å‘Š"""
    
    def __init__(self, debug_output_dir: str = "./debug_output"):
        """
        åˆå§‹åŒ–å¯è§†åŒ–å™¨
        
        Args:
            debug_output_dir: è°ƒè¯•è¾“å‡ºç›®å½•
        """
        self.debug_output_dir = debug_output_dir
        
    def generate_html_report(self, debug_results: Dict[str, Any], base_name: str):
        """
        ç”ŸæˆHTMLè°ƒè¯•æŠ¥å‘Š
        
        Args:
            debug_results: è°ƒè¯•ç»“æœå­—å…¸
            base_name: åŸºç¡€æ–‡ä»¶å
        """
        html_content = self._create_html_template(debug_results, base_name)
        
        output_path = os.path.join(self.debug_output_dir, f"{base_name}_debug_report.html")
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(html_content)
        
        logger.info(f"ğŸ“Š HTMLè°ƒè¯•æŠ¥å‘Šå·²ç”Ÿæˆ: {output_path}")
        return output_path
    
    def _create_html_template(self, debug_results: Dict[str, Any], base_name: str) -> str:
        """åˆ›å»ºHTMLæ¨¡æ¿"""
        
        file_info = debug_results.get("file_info", {})
        step_results = debug_results.get("step_results", {})
        
        html = f"""
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline è°ƒè¯•æŠ¥å‘Š - {file_info.get('file_name', base_name)}</title>
    <style>
        {self._get_css_styles()}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ” Pipeline è°ƒè¯•æŠ¥å‘Š</h1>
            <div class="file-info">
                <h2>ğŸ“„ {file_info.get('file_name', base_name)}</h2>
                <p><strong>å¤„ç†æ—¶é—´:</strong> {file_info.get('processing_time', 0):.2f} ç§’</p>
                <p><strong>ç”Ÿæˆæ—¶é—´:</strong> {debug_results.get('timestamp', '')}</p>
            </div>
        </header>
        
        <nav class="nav">
            <h3>ğŸ“‹ æ­¥éª¤å¯¼èˆª</h3>
            <ul>
                <li><a href="#overview">æ¦‚è§ˆ</a></li>
                <li><a href="#document-loading">æ–‡æ¡£åŠ è½½</a></li>
                <li><a href="#chunking">æ–‡æ¡£åˆ†å—</a></li>
                <li><a href="#embedding">Embedding</a></li>
                <li><a href="#vector-store">Vector Store</a></li>
                <li><a href="#concept-extraction">æ¦‚å¿µæå–</a></li>
                <li><a href="#concept-merging">æ¦‚å¿µåˆå¹¶</a></li>
                <li><a href="#evidence-extraction">è¯æ®æå–</a></li>
                <li><a href="#retrieval">æ£€ç´¢æµ‹è¯•</a></li>
                <li><a href="#qa-generation">é—®ç­”ç”Ÿæˆ</a></li>
            </ul>
        </nav>
        
        <main class="main">
            {self._generate_overview_section(step_results)}
            {self._generate_step_sections(step_results)}
        </main>
        
        <footer class="footer">
            <p>Generated by Pipeline Debugger at {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
        </footer>
    </div>
    
    <script>
        {self._get_javascript()}
    </script>
</body>
</html>
"""
        return html
    
    def _get_css_styles(self) -> str:
        """è·å–CSSæ ·å¼"""
        return """
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .file-info h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .nav {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .nav li a {
            display: block;
            padding: 8px 16px;
            background: #f8f9fa;
            color: #495057;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .nav li a:hover {
            background: #007bff;
            color: white;
        }
        
        .main {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .status-success {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #007bff;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
        
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .details-table th,
        .details-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .details-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .details-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .collapsible {
            background-color: #f1f1f1;
            color: #444;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .collapsible:hover {
            background-color: #ddd;
        }
        
        .collapsible.active {
            background-color: #007bff;
            color: white;
        }
        
        .content {
            padding: 0 18px;
            display: none;
            overflow: hidden;
            background-color: #f9f9f9;
            border-radius: 0 0 5px 5px;
        }
        
        .content.show {
            display: block;
            padding: 18px;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #6c757d;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        """
    
    def _generate_overview_section(self, step_results: Dict[str, Any]) -> str:
        """ç”Ÿæˆæ¦‚è§ˆéƒ¨åˆ†"""
        
        step_names = {
            "document_loading": "ğŸ“„ æ–‡æ¡£åŠ è½½",
            "chunking": "âœ‚ï¸ æ–‡æ¡£åˆ†å—", 
            "embedding": "ğŸ”¢ Embedding ç”Ÿæˆ",
            "vector_store": "ğŸ—„ï¸ Vector Store æ„å»º",
            "concept_extraction": "ğŸ§  æ¦‚å¿µæå–",
            "concept_merging": "ğŸ”— æ¦‚å¿µåˆå¹¶",
            "evidence_extraction": "ğŸ” è¯æ®æå–",
            "retrieval": "ğŸ¯ æ£€ç´¢æµ‹è¯•",
            "qa_generation": "â“ é—®ç­”ç”Ÿæˆ"
        }
        
        total_steps = len(step_names)
        successful_steps = sum(1 for step_key in step_names.keys() 
                             if step_results.get(step_key, {}).get("success", False))
        success_rate = (successful_steps / total_steps) * 100 if total_steps > 0 else 0
        
        overview_html = f"""
        <section id="overview" class="section">
            <h2>ğŸ“Š å¤„ç†æ¦‚è§ˆ</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{successful_steps}/{total_steps}</div>
                    <div class="stat-label">æˆåŠŸæ­¥éª¤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{success_rate:.1f}%</div>
                    <div class="stat-label">æˆåŠŸç‡</div>
                </div>
            </div>
            
            <h3>æ­¥éª¤çŠ¶æ€</h3>
            <table class="details-table">
                <thead>
                    <tr>
                        <th>æ­¥éª¤</th>
                        <th>çŠ¶æ€</th>
                        <th>å¤„ç†æ—¶é—´</th>
                        <th>è¯¦æƒ…</th>
                    </tr>
                </thead>
                <tbody>
        """
        
        for step_key, step_name in step_names.items():
            step_result = step_results.get(step_key, {})
            success = step_result.get("success", False)
            status_class = "status-success" if success else "status-error"
            status_text = "âœ… æˆåŠŸ" if success else "âŒ å¤±è´¥"
            time_taken = step_result.get("processing_time", 0)
            
            overview_html += f"""
                    <tr>
                        <td>{step_name}</td>
                        <td class="{status_class}">{status_text}</td>
                        <td>{time_taken:.2f}s</td>
                        <td><a href="#{step_key.replace('_', '-')}">æŸ¥çœ‹è¯¦æƒ…</a></td>
                    </tr>
            """
        
        overview_html += """
                </tbody>
            </table>
        </section>
        """
        
        return overview_html
    
    def _generate_step_sections(self, step_results: Dict[str, Any]) -> str:
        """ç”Ÿæˆå„æ­¥éª¤è¯¦ç»†éƒ¨åˆ†"""
        
        sections_html = ""
        
        # æ–‡æ¡£åŠ è½½
        doc_result = step_results.get("document_loading", {})
        if doc_result:
            sections_html += self._generate_document_loading_section(doc_result)
        
        # æ–‡æ¡£åˆ†å—
        chunk_result = step_results.get("chunking", {})
        if chunk_result:
            sections_html += self._generate_chunking_section(chunk_result)
        
        # Embedding
        embed_result = step_results.get("embedding", {})
        if embed_result:
            sections_html += self._generate_embedding_section(embed_result)
        
        # Vector Store
        vector_result = step_results.get("vector_store", {})
        if vector_result:
            sections_html += self._generate_vector_store_section(vector_result)
        
        # æ¦‚å¿µæå–
        concept_result = step_results.get("concept_extraction", {})
        if concept_result:
            sections_html += self._generate_concept_extraction_section(concept_result)
        
        # æ¦‚å¿µåˆå¹¶
        merge_result = step_results.get("concept_merging", {})
        if merge_result:
            sections_html += self._generate_concept_merging_section(merge_result)
        
        # è¯æ®æå–
        evidence_result = step_results.get("evidence_extraction", {})
        if evidence_result:
            sections_html += self._generate_evidence_extraction_section(evidence_result)
        
        # æ£€ç´¢
        retrieval_result = step_results.get("retrieval", {})
        if retrieval_result:
            sections_html += self._generate_retrieval_section(retrieval_result)
        
        # é—®ç­”ç”Ÿæˆ
        qa_result = step_results.get("qa_generation", {})
        if qa_result:
            sections_html += self._generate_qa_generation_section(qa_result)
        
        return sections_html
    
    def _generate_document_loading_section(self, result: Dict[str, Any]) -> str:
        """ç”Ÿæˆæ–‡æ¡£åŠ è½½éƒ¨åˆ†"""
        if not result.get("success"):
            return f"""
            <section id="document-loading" class="section">
                <h2>ğŸ“„ æ–‡æ¡£åŠ è½½</h2>
                <p class="status-error">âŒ å¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}</p>
            </section>
            """
        
        return f"""
        <section id="document-loading" class="section">
            <h2>ğŸ“„ æ–‡æ¡£åŠ è½½</h2>
            <p class="status-success">âœ… æˆåŠŸ</p>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{result.get('documents_count', 0)}</div>
                    <div class="stat-label">æ–‡æ¡£æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{result.get('total_characters', 0):,}</div>
                    <div class="stat-label">æ€»å­—ç¬¦æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{result.get('processing_time', 0):.2f}s</div>
                    <div class="stat-label">å¤„ç†æ—¶é—´</div>
                </div>
            </div>
            
            <button class="collapsible">æŸ¥çœ‹æ–‡æ¡£è¯¦æƒ…</button>
            <div class="content">
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>ç´¢å¼•</th>
                            <th>æ–‡æœ¬é•¿åº¦</th>
                            <th>æ–‡æœ¬é¢„è§ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
        """
        
        for doc_detail in result.get('document_details', []):
            return f"""
                        <tr>
                            <td>{doc_detail.get('index', 0)}</td>
                            <td>{doc_detail.get('text_length', 0):,}</td>
                            <td>{doc_detail.get('text_preview', '')[:100]}...</td>
                        </tr>
            """
        
        return """
                    </tbody>
                </table>
            </div>
        </section>
        """
    
    def _generate_chunking_section(self, result: Dict[str, Any]) -> str:
        """ç”Ÿæˆåˆ†å—éƒ¨åˆ†"""
        if not result.get("success"):
            return f"""
            <section id="chunking" class="section">
                <h2>âœ‚ï¸ æ–‡æ¡£åˆ†å—</h2>
                <p class="status-error">âŒ å¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}</p>
            </section>
            """
        
        stats = result.get('chunking_stats', {})
        
        return f"""
        <section id="chunking" class="section">
            <h2>âœ‚ï¸ æ–‡æ¡£åˆ†å—</h2>
            <p class="status-success">âœ… æˆåŠŸ</p>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{result.get('chunks_count', 0)}</div>
                    <div class="stat-label">å—æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{stats.get('avg_chunk_length', 0):.0f}</div>
                    <div class="stat-label">å¹³å‡å—é•¿åº¦</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{stats.get('min_chunk_length', 0)}</div>
                    <div class="stat-label">æœ€å°å—é•¿åº¦</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{stats.get('max_chunk_length', 0)}</div>
                    <div class="stat-label">æœ€å¤§å—é•¿åº¦</div>
                </div>
            </div>
        </section>
        """
    
    def _generate_concept_extraction_section(self, result: Dict[str, Any]) -> str:
        """ç”Ÿæˆæ¦‚å¿µæå–éƒ¨åˆ†"""
        if not result.get("success"):
            return f"""
            <section id="concept-extraction" class="section">
                <h2>ğŸ§  æ¦‚å¿µæå–</h2>
                <p class="status-error">âŒ å¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}</p>
            </section>
            """
        
        stats = result.get('concept_stats', {})
        
        return f"""
        <section id="concept-extraction" class="section">
            <h2>ğŸ§  æ¦‚å¿µæå–</h2>
            <p class="status-success">âœ… æˆåŠŸ</p>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{result.get('concepts_count', 0)}</div>
                    <div class="stat-label">æå–æ¦‚å¿µæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{stats.get('avg_concepts_per_chunk', 0):.1f}</div>
                    <div class="stat-label">å¹³å‡æ¯å—æ¦‚å¿µæ•°</div>
                </div>
            </div>
        </section>
        """
    
    def _generate_qa_generation_section(self, result: Dict[str, Any]) -> str:
        """ç”Ÿæˆé—®ç­”ç”Ÿæˆéƒ¨åˆ†"""
        if not result.get("success"):
            return f"""
            <section id="qa-generation" class="section">
                <h2>â“ é—®ç­”ç”Ÿæˆ</h2>
                <p class="status-error">âŒ å¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}</p>
            </section>
            """
        
        stats = result.get('qa_stats', {})
        
        return f"""
        <section id="qa-generation" class="section">
            <h2>â“ é—®ç­”ç”Ÿæˆ</h2>
            <p class="status-success">âœ… æˆåŠŸ</p>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{result.get('qa_pairs_count', 0)}</div>
                    <div class="stat-label">é—®ç­”å¯¹æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{stats.get('avg_question_length', 0):.0f}</div>
                    <div class="stat-label">å¹³å‡é—®é¢˜é•¿åº¦</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{stats.get('avg_answer_length', 0):.0f}</div>
                    <div class="stat-label">å¹³å‡ç­”æ¡ˆé•¿åº¦</div>
                </div>
            </div>
            
            <h3>é—®é¢˜ç±»å‹åˆ†å¸ƒ</h3>
            <p>{', '.join(stats.get('question_types', []))}</p>
        </section>
        """
    
    def _generate_embedding_section(self, result: Dict[str, Any]) -> str:
        """ç”Ÿæˆå…¶ä»–æ­¥éª¤çš„é€šç”¨éƒ¨åˆ†"""
        return ""
    
    def _generate_vector_store_section(self, result: Dict[str, Any]) -> str:
        return ""
    
    def _generate_concept_merging_section(self, result: Dict[str, Any]) -> str:
        return ""
    
    def _generate_evidence_extraction_section(self, result: Dict[str, Any]) -> str:
        return ""
    
    def _generate_retrieval_section(self, result: Dict[str, Any]) -> str:
        return ""
    
    def _get_javascript(self) -> str:
        """è·å–JavaScriptä»£ç """
        return """
        // æŠ˜å é¢æ¿åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            var coll = document.getElementsByClassName("collapsible");
            for (var i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    content.classList.toggle("show");
                });
            }
            
            // å¹³æ»‘æ»šåŠ¨
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        });
        """ 